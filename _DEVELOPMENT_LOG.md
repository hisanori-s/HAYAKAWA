# HAYAKAWA EC 開発ログ

-----------------------------------------------------------------------------

## 2024-12-26 14:30:00

### 目的・ゴール
- Square Checkout APIでの在庫管理問題を解決
- カタログ商品との正しい紐付けを実現

### 試したこと
1. Quick Pay方式からOrder-based Checkoutへの移行
   - 商品名と価格のみを送信する実装から、catalogObjectIdを使用する実装へ変更
   - 在庫管理のためのカスタム実装を削除
   - リクエストボディをシンプル化

2. 在庫管理の自動化
   - ECサイト側での在庫チェック処理を削除
   - Square側の自動在庫管理機能を活用
   - カタログ商品との正しい紐付けを実装

### 解決方法
1. チェックアウトAPIのリクエストをシンプル化
   ```typescript
   lineItems: items.map((item) => ({
     catalogObjectId: item.catalogObjectId,
     quantity: item.quantity.toString()
   }))
   ```
   - catalogObjectIdのみを送信し、Square側での自動在庫管理を有効化
   - 余分な価格情報や在庫チェック処理を削除

### 学んだ点・注意点
- Square Catalogとの紐付けさえ正しければ、在庫管理は自動的に行われる
- ECサイト側での在庫管理は不要で、むしろ余計な処理が問題を引き起こす可能性がある
- シンプルな実装を心がけ、Square側の機能を最大限活用することが重要

-----------------------------------------------------------------------------

## 2024-12-26 10:32:34

### 目的・ゴール
- カート内商品の在庫状態に応じた決済ボタンの制御を改善
- 在庫エラー状態の適切な管理と解除を実装

### 実装内容
1. 在庫エラー状態の管理改善
   - 在庫エラー状態のクリア機能を追加
   - ローカルでの在庫状態チェックを実装
   - 不要なAPI呼び出しを削減

2. 決済ボタンの制御最適化
   - 在庫状態に基づく決済ボタンの有効/無効制御
   - 在庫エラー解消時の即時反映
   - ユーザー操作に対する即時フィードバック

### 主要な変更
1. 在庫エラー管理の改善
   - 数量変更時のローカルチェック機能追加
   - 商品削除時のエラー状態再評価機能追加
   - 在庫状態の変更を即時反映する処理を実装

2. パフォーマンスの最適化
   - 不要なAPI呼び出しを削減
   - ローカルでの在庫状態チェックを優先
   - 必要な場合のみサーバー側での在庫確認を実行

### 問題点と解決
1. 決済ボタンの制御
   - 問題：在庫数調整後も決済ボタンが無効のまま
   - 解決：ローカルでの在庫状態チェックと即時のエラー状態クリアを実装

2. API呼び出しの最適化
   - 問題：不要なAPI呼び出しによるパフォーマンス低下
   - 解決：ローカルチェックを優先し、必要な場合のみAPIを呼び出す方式に変更

-----------------------------------------------------------------------------

## 2024-12-24 18:13:55

### 目的・ゴール
- カート内の在庫オーバー商品に対する数量増加ボタンの制御を改善
- 在庫数を超える注文の防止機能を強化

### 実装内容
1. 在庫オーバー商品の数量増加ボタン制御
   - 在庫オーバー状態の判定ロジックを追加
   - 在庫数を超える商品の数量増加ボタンを無効化
   - 在庫数以下まで数量を減らすと増加ボタンを有効化

2. 在庫確認ロジックの最適化
   - 在庫オーバー商品の監視を効率化
   - 不要な在庫確認を削除
   - 在庫確認のタイミングを最適化

### 主要な変更
1. 数量増加ボタンの制御ロジック改善
   - 在庫オーバー状態での増加操作を防止
   - 在庫管理対象商品の制御を強化
   - 在庫管理対象外の商品は通常通り操作可能

2. UIフィードバックの改善
   - 在庫オーバー商品の視覚的な表示
   - 操作不可能な状態の明確な表示
   - ユーザーへの適切なガイダンス提供

### 問題点と解決
1. 在庫オーバー商品の制御
   - 問題：在庫オーバー状態でも数量増加が可能
   - 解決：在庫状態に基づく増加ボタンの無効化を実装

2. ユーザー体験の改善
   - 問題：在庫状態が不明確
   - 解決：視覚的フィードバックとエラーメッセージの改善

-----------------------------------------------------------------------------

## 2024-12-24 11:50:53

### 目的・ゴール
- カート在庫確認機能の状態管理を最適化
- 在庫確認の無限ループ問題を解決

### 実装内容
1. 状態管理の問題分析
   - 在庫確認のトリガーが重複
   - `isValidatingInventory`の状態管理が不適切
   - 複数の`useEffect`による副作用の連鎖

2. 状態管理の再設計
   - 在庫確認に関する状態を一つのオブジェクトに統合
   - 状態更新を単一の関数で管理するように変更
   - 依存関係の整理と不要な再レンダリングの防止

3. 在庫確認フローの見直し
   - 初回ロード時の確認を1回だけ実行するように修正
   - 数量変更時の確認を最適化
   - 不要な再確認を防止する仕組みを導入

### 問題点と解決
1. 状態管理の複雑化
   - 問題：複数の状態が相互に影響し、予期せぬ再レンダリングが発生
   - 解決：状態を一つのオブジェクトに統合し、更新ロジックを単純化

2. 在庫確認の無限ループ
   - 問題：依存配列の設定が不適切で、在庫確認が無限に実行される
   - 解決：依存関係を見直し、必要な場合のみ在庫確認を実行するように修正

3. パフォーマンスの低下
   - 問題：不要な再レンダリングによるパフォーマンス低下
   - 解決：メモ化を適切に使用し、必要な場合のみ再レンダリングを実行

-----------------------------------------------------------------------------

## 2024-12-24 10:27:39

### 目的・ゴール
- カート内商品の在庫確認機能の改善
- 在庫確認ロジックの最適化と信頼性向上

### 実装内容
1. 在庫確認ロジックの修正
   - APIレスポンスの形式（`counts`配列）に合わせて処理を修正
   - 在庫情報を適切なマップ形式に変換して使用
   - 在庫確認ロジックを`cart/page.tsx`に集約

2. 在庫確認のタイミング最適化
   - ページロード時の在庫確認を実装
   - 注文時の最新在庫確認を実装
   - 不要な在庫確認を削除

3. デバッグ情報の拡充
   - 在庫管理商品情報の表示を追加
   - 在庫確認状態の表示を追加
   - デバッグログの追加

### 主要な変更
1. 在庫確認ロジックの改善
   - `cart-provider.tsx`から在庫確認ロジックを移動
   - 在庫情報の取得と処理を一元化
   - エラーハンドリングの強化

2. 在庫確認の最適化
   - 在庫管理が必要な商品の判定を追加
   - 在庫確認の実行タイミングを最適化
   - 不要な在庫確認を省略

### 問題点と解決
1. APIレスポンスの処理
   - 問題：APIレスポンスの形式と処理の不一致
   - 解決：`counts`配列を適切なマップ形式に変換

2. 在庫確認のタイミング
   - 問題：在庫確認のタイミングが不適切
   - 解決：ページロード時と注文時の2段階確認を実装

3. 在庫情報の表示
   - 問題：デバッグ情報が不十分
   - 解決：在庫管理商品情報と確認状態の表示を追加

-----------------------------------------------------------------------------

## 2024-12-23 17:16:01

### 目的・ゴール
- カート内商品の注文数制限を定数化し、コードの保守性を向上
- 注文数制限の一元管理を実現

### 実装内容
1. 注文関連の定数ファイルを作成
   - `lib/constants/order.ts`を作成
   - `DefaultMaxOrderQuantity`を定義（デフォルト値：10）
   - `ORDER_SETTINGS`オブジェクトで将来の拡張に対応

2. 定数の適用
   - `lib/store/cart.ts`：カートアイテムのデフォルト値として使用
   - `components/product-list.tsx`：商品追加時の上限値として使用

### 主要な変更
1. 定数の一元管理
   - ハードコードされていた最大注文数を定数化
   - 在庫管理商品の注文数制限ロジックを整理
   - 将来的な拡張性を考慮した設計

2. コードの改善
   - 定数の参照方法を統一
   - 関連ファイルでの一貫した使用を確認
   - コードの可読性と保守性が向上

### 問題点と解決
1. 定数の適用範囲
   - 問題：複数のファイルで同じ値がハードコードされていた
   - 解決：定数ファイルを作成し、一元管理を実現

2. 拡張性の確保
   - 問題：将来的な設定の追加に対する柔軟性が必要
   - 解決：`ORDER_SETTINGS`オブジェクトを導入し、設定の拡張に対応

-----------------------------------------------------------------------------

## 2024-12-22 14:00:00

### 目的・ゴール
- 在庫管理機能の実装と在庫数に基づく購入数制限の追加
- 在庫数の表示と在庫切れ商品の制御

### 実装内容
1. Square Inventory APIの実装
   - 在庫数取得用のAPIエンドポイントを作成
   - バリエーションごとの在庫数を取得する機能を実装
   - エラー時のフォールバック処理を追加

2. 商品表示の改善
   - バリエーション選択時に在庫数を表示
   - 在庫切れ商品の選択を無効化
   - 在庫数に基づく購入数の制限機能を実装
     - 在庫が10個以上：最大10個まで購入可能
     - 在庫が1-9個：在庫数を上限として購入可能
     - 在庫なし：購入不可

3. デバッグ機能の強化
   - 在庫管理商品の情報をデバッグパネルに表示
   - 在庫数の状態をリアルタイムで確認可能に

### 主要な変更
1. 在庫管理ロジックの実装
   - 在庫数に基づく購入制限の追加
   - バリエーション選択時の在庫数表示
   - 在庫切れ商品の制御機能

2. UIの改善
   - 在庫数の表示方法を最適化
   - 在庫切れ商品の視覚的なフィードバック
   - 購入数選択UIの制御機能追加

### 問題点と解決
1. 在庫数の取得と表示
   - 問題：在庫数が正しく反映されない場合がある
   - 解決：在庫数の取得タイミングを商品データ取得時に一括で行うように修正

2. 購入数制限の動作
   - 問題：在庫数が8個の商品で購入数を選択できない
   - 解決：getMaxQuantity関数のロジックを修正し、在庫数に基づく正確な制限を実装

-----------------------------------------------------------------------------

## 2024-12-22 12:00:00

### 実装済み機能
1. 商品詳細モーダルの改善
   - バリエーション選択機能の実装
     - バリエーションが1つの場合は自動選択
     - バリエーションが2つ以上の場合のみ選択UI表示
     - 選択必須制御（未選択時はカートボタン無効化）
   - 商品情報表示の改善
     - カテゴリと商品名をパンくずリスト形式で表示（例：グッズ > ポーチ）
     - カテゴリ名から'EC_'プレフィックスを除去
   - レイアウトの最適化
     - 価格表示の右詰め
     - 注文数入力欄の右詰め
     - カートボタンをフルワイド化
   - 注文制御の改善
     - 数量0の場合はカートボタン無効化
     - バリエーション必須時の選択制御

### 主要な変更
1. バリエーション判定ロジックの改善
   - Square APIの仕様に合わせて判定方法を修正
   - variations配列の長さで判定（1つの場合は通常商品、2つ以上でバリエーション商品）

2. UIの改善
   - モーダル内のレイアウト最適化
   - 商品情報の階層構造を視覚的に表現
   - 操作性の向上（必須選択の明確化）

-----------------------------------------------------------------------------

## 2024-12-22 11:00:00

### 実装済み機能
1. デバッグ情報の改善
   - デバッグ情報をアコーディオン形式に変更
   - カテゴリ構造の視覚化を改善
   - 開発環境のみでの表示を維持

### 主要な変更
1. UIの改善
   - デバッグ情報の表示をよりコンパクトに
   - アコーディオンによる表示/非表示の切り替え機能を追加
   - shadcn/uiのアコーディオンコンポーネントを活用

-----------------------------------------------------------------------------

## 2024-02-10 12:00:00

### 実装済み機能
1. 金額表示の修正
   - Square APIからの金額をそのまま使用するように修正
   - デモ商品の金額も円単位に統一
   - 不要な金額変換処理を削除（1/100の処理を削除）


-----------------------------------------------------------------------------

## 2024-02-09 12:00:00

### 実装済み機能
1. Square SDK連携の改善
   - APIからSDKへの移行完了
   - BigIntシリアライズ問題の解決
   - 商品データの取得と表示の実装

2. 商品画像の実装
   - モーダル内のみの画像表示に変更
   - プレースホルダー画像の設定
   - 画像表示の最適化

-----------------------------------------------------------------------------

## 2024-02-07 12:00:00

### 実装済み機能
1. 基本的なUI実装
   - shadcn/uiの導入
   - ヘッダーコンポーネント
   - タブナビゲーション
   - レスポンシブデザイン

2. 商品表示機能
   - 商品一覧の実装
   - 商品詳細モーダル
   - 価格表示の調整（円表示）

3. カート機能
   - Zustandによる状態管理
   - LocalStorageによる永続化
   - カートアイコンとバッジ
   - カートページの実装
   - 数量変更機能
   - 商品削除機能

4. Square連携
   - Square APIクライアントの設定
   - 商品データ構造の整備
   - チェックアウトAPIの実装
   - 注文完了ページの作成

### 主要な変更
1. カートの状態管理を改善
   - 同じ商品を追加した際の数量加算処理
   - LocalStorageとの連携強化

2. UIの改善
   - タブレイアウトの調整
   - カートアイコンの配置変更
   - 商品一覧のレイアウト最適化
