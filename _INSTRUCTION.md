# カート在庫確認機能の修正 - 状態管理の最適化

## 現在の問題
1. 在庫確認の無限ループ
   - 決済へ進むボタンが「在庫確認中」の状態から抜け出せない
   - `isValidatingInventory`の状態管理が適切に行われていない
   - 在庫確認のトリガーが重複している可能性

2. 状態管理の課題
   - 複数の`useEffect`による副作用の連鎖
   - 在庫確認の依存関係が複雑化
   - 状態更新のタイミングが不明確

## 解決の方針
1. 状態管理の単純化
   - 在庫確認のトリガーを明確に定義
   - 状態更新のタイミングを整理
   - 不要な依存関係の削除

2. 在庫確認フローの再設計
   ```mermaid
   graph TD
     A[ページロード] --> B{在庫管理商品あり?}
     B -- Yes --> C[初回在庫確認]
     B -- No --> D[確認不要]
     C --> E[状態更新]
     E --> F{数量変更?}
     F -- Yes --> G[在庫再確認]
     F -- No --> H[完了]
   ```

3. 実装の優先順位
   a. 在庫確認ロジックの単純化
   b. 状態管理の整理
   c. エラーハンドリングの改善

## 現在のコードベース
1. `app/cart/page.tsx`
   - 在庫確認ロジックが複雑化
   - 複数の`useEffect`が相互に影響
   - 状態管理が分散

2. 主要な状態
   ```typescript
   const [isValidatingInventory, setIsValidatingInventory] = useState(false);
   const [needsInventoryCheck, setNeedsInventoryCheck] = useState(false);
   const [inventoryError, setInventoryError] = useState<string | null>(null);
   const [inventoryItems, setInventoryItems] = useState<Array<...>>([]);
   ```

## 修正方針
1. 状態管理の集約
   - 在庫確認に関する状態を一つのオブジェクトに統合
   - 状態更新を単一の関数で管理
   ```typescript
   interface InventoryState {
     isValidating: boolean;
     needsCheck: boolean;
     error: string | null;
     items: Array<...>;
   }
   ```

2. 在庫確認ロジックの単純化
   - 初回ロード時の確認を1回だけ実行
   - 数量変更時の確認を最適化
   - 不要な再確認を防止

3. エラーハンドリングの改善
   - エラー状態の明確な管理
   - ユーザーへの適切なフィードバック
   - リカバリー手順の提供

## 実装手順
1. 状態管理の再構築
   - 統合された状態オブジェクトの実装
   - 状態更新関数の作成
   - 依存関係の整理

2. 在庫確認ロジックの修正
   - 初回ロードの処理を単純化
   - 数量変更時の処理を最適化
   - 確認トリガーの明確化

3. UI/UXの改善
   - ローディング状態の表示を改善
   - エラーメッセージの表示を最適化
   - ユーザーアクションの制御を改善

## 注意点
1. 状態管理
   - 状態更新は必ず単一の関数を通して行う
   - 副作用の連鎖を防ぐ
   - デバッグ情報を活用して状態変化を追跡

2. パフォーマンス
   - 不要な再レンダリングを防ぐ
   - メモ化を適切に使用
   - 非同期処理の最適化

3. エラーハンドリング
   - エラー状態を明確に管理
   - ユーザーへの適切なフィードバック
   - リカバリー手順の提供

## 必要なファイル
1. `app/cart/page.tsx`
   - 在庫確認ロジックの修正
   - 状態管理の改善
   - UIの最適化

2. `lib/store/cart.ts`
   - カート状態の型定義
   - 在庫確認関連の型定義

## 完了条件
1. 在庫確認の無限ループが解消されていること
2. 決済ボタンの状態が適切に更新されること
3. エラー状態が適切に管理されていること
4. ユーザー体験が改善されていること

## デバッグ方法
1. 状態変化のログ出力
2. デバッグパネルでの状態確認
3. エラー発生時の詳細情報収集

## セキュリティ要件
1. APIトークンの適切な管理
2. 在庫データの整合性確保
3. ユーザー入力の検証

## 次のAIへの指示
1. まず現状の問題を冷静に分析してください
   - 状態管理の流れを図示
   - 問題の根本原因を特定
   - 解決の優先順位を決定

2. 段階的な修正アプローチを取ってください
   - 状態管理の単純化から着手
   - 一つずつ変更を加えて検証
   - 変更の影響を慎重に確認

3. デバッグ情報を活用してください
   - 状態変化のログを確認
   - エラーの発生パターンを分析
   - 修正の効果を検証
