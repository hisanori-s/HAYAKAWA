# 商品一覧の表示パフォーマンス改善

## 現在の課題
商品一覧画面の初期表示が遅い状態にあります。原因として、以下が推測されます：
- 全商品の詳細情報を一括取得してから表示している可能性
- 不要な情報まで初期表示時に取得している可能性

## 改善提案
2段階での商品情報取得による表示の高速化：

1. 第1段階（初期表示）
   - 必要最小限の情報のみを先に取得
     - 商品名
     - バリエーションID
     - カテゴリ
     - 金額
   - これらの情報で一覧表示を構成
   - この段階では在庫状態（売り切れ）表示は不要

2. 第2段階（非同期取得）
   - 商品詳細情報を非同期で取得
   - ユーザーの操作に応じて必要な情報を取得
   - 取得完了後に表示を更新
   - 在庫情報を取得し、売り切れ表示を後から追加

## 確認・実装項目

### 1. 現状の実装確認
1. 商品情報取得のフロー
   - `app/page.tsx`
   - `components/product-list.tsx`
   - `lib/square/client.ts`の商品取得関連の実装

2. Square APIの呼び出し方法
   - 現在のエンドポイント使用状況
   - バッチ処理の有無
   - キャッシュの実装状況

### 2. パフォーマンス計測
1. 現状の表示速度計測
   - 初期表示までの時間
   - 商品情報取得にかかる時間
   - APIレスポンスタイム

2. ボトルネックの特定
   - ネットワーク転送時間
   - データ処理時間
   - レンダリング時間

### 3. 改善実装の検討
1. APIエンドポイントの最適化
   ```typescript
   // 基本情報取得用エンドポイントの提案
   GET /api/square/catalog/basic
   // レスポンス例
   {
     items: [{
       id: string,
       name: string,
       variationId: string,
       category: string,
       price: number
     }]
   }

   // 詳細情報取得用エンドポイントの提案（在庫情報を含む）
   GET /api/square/catalog/detail/:id
   // レスポンス例
   {
     description: string,
     images: string[],
     inventory: {
       quantity: number,
       isSoldOut: boolean
     }
   }
   ```

2. フロントエンド実装
   ```typescript
   // 2段階取得の実装例
   const ProductList = () => {
     // 基本情報の取得と表示
     const { data: basicItems } = useQuery(['products', 'basic'], getBasicProducts);

     // 詳細情報の非同期取得の提案（在庫情報を含む）
     const { data: details } = useQuery(
       ['products', 'details'],
       getProductDetails,
       { enabled: !!basicItems }
     );

     return (
       <div>
         {basicItems?.map(item => (
           <ProductCard
             key={item.id}
             basicInfo={item}
             details={details?.[item.id]}
             // 詳細情報が取得できた場合のみ売り切れ表示
             isSoldOut={details?.[item.id]?.inventory.isSoldOut}
           />
         ))}
       </div>
     );
   };
   ```

## 必要なファイル
1. `app/api/square/catalog/route.ts`
   - 現在の商品取得ロジックの確認
   - APIエンドポイントの実装状態

2. `components/product-list.tsx`
   - 商品一覧の表示ロジック
   - データ取得と表示の制御方法

3. `lib/square/client.ts`
   - Square APIクライアントの実装
   - データ取得メソッドの実装

## 完了条件
1. 商品一覧の初期表示が現状より高速化されること
2. ユーザー体験を損なわない形で詳細情報が表示されること
3. パフォーマンス改善の効果が計測可能であること
4. 売り切れ表示が詳細情報取得後に適切に反映されること

## 次のAIへの指示
1. まず、現在の実装を確認し、パフォーマンスのボトルネックを特定してください
2. 2段階での商品情報取得の実現可能性を検証してください
3. 以下の観点で改善案を提示してください：
   - 初期表示の高速化
   - ユーザー体験の最適化（売り切れ表示の後出しを含む）
   - 実装の複雑性とメンテナンス性
4. 改善案の実装手順と期待される効果を具体的に示してください

## 参考情報
Square Catalog APIの特徴：
- バッチ処理による複数商品の一括取得が可能
- キャッシュの活用でレスポンスタイムを改善可能
- 必要なフィールドの指定による応答サイズの最適化が可能
- 在庫情報は別APIで取得する必要があり、基本情報とは分離可能
- 第１段階での情報取得時に売り切れ情報の取得を含めることに対してとくにUX上の問題がない場合は、第１段階の時点で売り切れ情報の取得を含めてもよい

---

# メール自動送信機能の実装

## 現在の課題
注文完了時の自動メール送信機能が未実装の状態です。以下の実装が必要です：
- 購入者のメールアドレスの取得方法の確認
- 注文情報の取得方法の確認
- メール送信機能の実装

## 実装項目

### 1. 注文情報の取得
1. Square APIからの注文情報取得
   - 注文IDを使用した注文詳細の取得
   - 購入者のメールアドレスの取得方法の確認
   - 必要な注文情報の特定

2. APIエンドポイントの実装
   ```typescript
   // 注文情報取得用エンドポイント
   GET /api/square/order/:orderId
   // レスポンス例
   {
     orderInfo: {
       orderId: string,
       customerEmail: string,
       items: Array<{
         name: string,
         quantity: number,
         price: number
       }>,
       totalAmount: number
     }
   }
   ```

### 2. メール送信機能の実装
1. メール送信用APIエンドポイントの実装
   - 既存の`/api/email/auto-reply/route.ts`の実装
   - メールテンプレートの適用
   - エラーハンドリングの実装

2. メール送信のトリガー実装
   - 注文完了時のメール送信トリガーの設定
   - 送信状態の管理
   - 再送機能の検討

## 必要なファイル
1. `app/api/square/order/route.ts`（新規作成）
   - 注文情報取得用APIの実装
   - Square APIとの連携処理

2. `app/api/email/auto-reply/route.ts`
   - メール送信処理の実装
   - テンプレート適用ロジック

3. `lib/constants/email.ts`
   - メールテンプレートの定義
   - 送信元アドレス等の設定

## 完了条件
1. 注文完了時に自動的にメールが送信されること
2. メールには以下の情報が含まれること：
   - 注文番号
   - 購入商品の詳細（商品名、数量、金額）
   - 合計金額
3. エラー時の適切なハンドリングが実装されていること
4. メール送信のログが記録されること

## 次のAIへの指示
1. まず、Square APIから注文情報を取得する方法を確認してください
2. メール送信機能の実装方針を決定してください
3. 以下の順序で実装を進めてください：
   - 注文情報取得APIの実装
   - メール送信機能の実装
   - エラーハンドリングの実装
4. 実装完了後、テスト注文を行いメール送信が正常に機能することを確認してください

## 参考情報
- メールアドレスは必ず入力されている前提で実装可能
- 注文番号から注文情報は取得可能
- Square APIの`RetrieveOrder`エンドポイントを使用して注文詳細を取得可能
- メール送信にはNodemailerなどのライブラリの使用を検討
